#!/usr/bin/env ruby
# frozen_string_literal: true

require 'securerandom'

puts "ğŸš€ Ruby Tap ç®¡ç†è€…ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ"
puts "=" * 50

# ç®¡ç†è€…æƒ…å ±ã®è¨­å®š
loop do
  print "ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: "
  email = gets.chomp

  if email.empty?
    puts "âŒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™"
    next
  end

  unless email.include?('@')
    puts "âŒ æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
    next
  end

  break
end

print "ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼å (ç©ºç™½ã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰è‡ªå‹•ç”Ÿæˆ): "
username = gets.chomp
username = email.split('@').first if username.empty?

puts "\nğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š:"
puts "1. è‡ªåˆ†ã§è¨­å®šã™ã‚‹ï¼ˆæ¨å¥¨ï¼‰"
puts "2. ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã™ã‚‹"
print "é¸æŠ (1/2): "
choice = gets.chomp

if choice == "2"
  password = SecureRandom.alphanumeric(16) + "!@#"
  puts "ğŸ“ ãƒ©ãƒ³ãƒ€ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸ"
else
  loop do
    print "ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼‰: "
    password = gets.chomp

    if password.length < 8
      puts "âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„"
      next
    end

    print "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª: "
    password_confirm = gets.chomp

    if password == password_confirm
      break
    else
      puts "âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚å†åº¦å…¥åŠ›ã—ã¦ãã ã•ã„"
    end
  end
end

puts "\nğŸ“ è¨­å®šæƒ…å ±:"
puts "Email: #{email}"
puts "Username: #{username}"
puts "Password: #{password}"

puts "\nğŸ”§ fly.ioç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šä¸­..."

# fly.ioã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
system("fly secrets set ADMIN_EMAIL='#{email}' ADMIN_USERNAME='#{username}' ADMIN_PASSWORD='#{password}'")

puts "\nâœ… ç’°å¢ƒå¤‰æ•°ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ"
puts "\nğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
puts "1. fly deploy ã§ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤"
puts "2. fly ssh console -C '/rails/bin/rails admin:create' ã§ç®¡ç†è€…ã‚’ä½œæˆ"
puts "3. https://ruby-tap.fly.dev/admin ã«ã‚¢ã‚¯ã‚»ã‚¹"
puts "4. Email: #{email}, Password: #{password} ã§ãƒ­ã‚°ã‚¤ãƒ³"
puts "\nğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„äº‹é …:"
puts "- ã“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å®‰å…¨ãªå ´æ‰€ã«ä¿å­˜ã—ã¦ãã ã•ã„"
puts "- å®šæœŸçš„ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™"
